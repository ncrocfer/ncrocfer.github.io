<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ncrocfer, Python & Web security">

    
    <title>Création d'API avec Scrapy et Django // ncrocfer // Python & Web security</title>
    

    

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://ncrocfer.github.io/css/pure.css">
    <link rel="stylesheet" href="https://ncrocfer.github.io/css/pygments.css">
    

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    
<script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
<script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>

</head>

<body>

<div class="pure-g-r" id="layout">
    <div class="sidebar pure-u">
    <div class="cover-img" style="background-color: #0D302E;">
        <div class="cover-body">
            <header class="header">
                <hgroup>
                    <h1 class="brand-main"><a href="/">ncrocfer</a></h1>
                    <p class="tagline">Python & Web security</p>
                    
                    
                    <p class="links"><a href="https://ncrocfer.github.io/a-propos">A propos</a></p>
                    
                    
                    <p class="social">
                        
                        <a href="https://twitter.com/ncrocfer">
                            <i class="fa fa-twitter-square fa-3x"></i>
                        </a>
                        
                        <a href="https://github.com/ncrocfer">
                            <i class="fa fa-github fa-3x"></i>
                        </a>
                        
                    <p>
                </hgroup>
            </header>
        </div>
    </div>
</div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>Création d'API avec Scrapy et Django</h1>
                    
                        <p class="post-meta">
                            
                                category:
                            
                            
                                <a href="https://ncrocfer.github.io/categories/howtos">Howtos</a> 
                            , date: Thu 27 August 2015
                        </p>
                    
                    
                        <p class="post-meta">
                            
                                tags =
                            
                            
                                <a class="post-category" href="https://ncrocfer.github.io/tags/python">python</a>
                            
                                <a class="post-category" href="https://ncrocfer.github.io/tags/django">django</a>
                            
                                <a class="post-category" href="https://ncrocfer.github.io/tags/scrapy">scrapy</a>
                            
                                <a class="post-category" href="https://ncrocfer.github.io/tags/api">api</a>
                            
                        </p>
                    
                </header>
            </section>
            <div class="document">
<p>La majorité des API se font désormais au format REST. Sous Django, de telles API peuvent facilement se créer grâce au toolkit <strong>Django REST framework</strong>.</p>
<p>Nous allons voir dans cet article comment créer une API REST sous Django. Pour que l'exemple soit ludique, nous créerons une API fournissant la liste complète des bières belge ! Pour cela nous utiliserons Scrapy afin de parser la page Wikipédia correspondante, puis nous utiliserons les modèles Django pour insérer les données en base.</p>

<div class="section" id="setup">
<h2>Setup</h2>
<p>On commence par créer un nouvel environnement virtuel qui contiendra l'ensemble des packages utiles à notre projet :</p>
<div class="highlight"><pre><span class="nv">$ </span>mkvirtualenv beer-rest
<span class="nv">$ </span>pip install Scrapy scrapy-djangoitem Django djangorestframework
</pre></div>
<p>Dans l'ordre :</p>
<ul class="simple">
<li><strong>Scrapy</strong> va nous servir à parser la page Wikipédia et retourner les informations souhaitées,</li>
<li><strong>scrapy-djangoitem</strong> nous permettra d'utiliser les modèles Django dans notre projet Scrapy,</li>
<li><strong>Django</strong> sera notre framework web,</li>
<li><strong>djangorestframework</strong> va nous permettre de créer facilement notre API REST.</li>
</ul>
<p>Nous pouvons maintenant créer notre projet Django <strong>alcohol</strong>, ainsi que l'application <strong>beer</strong> :</p>
<div class="highlight"><pre><span class="nv">$ </span>django-admin startproject alcohol
<span class="nv">$ </span><span class="nb">cd </span>alcohol
<span class="nv">$ </span>./manage.py startapp beer
</pre></div>
</div>
<div class="section" id="creation-du-modele">
<h2>Création du modèle</h2>
<p>La page Wikipédia <a class="reference external" href="https://fr.wikipedia.org/wiki/Liste_des_bi%C3%A8res_belges">suivante</a> propose la liste complète des bières belges, par ordre alphabétique.</p>
<p>Nous allons enregistrer en base les informations données, à savoir :</p>
<ul class="simple">
<li>le nom de la bière</li>
<li>le type</li>
<li>la teneur en alcool</li>
<li>la brasserie</li>
</ul>
<p>Voici le modèle correspondant :</p>
<div class="highlight"><pre><span class="c"># ./alcohol/beer/models.py</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Beer</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">nom</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">degre</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">brasserie</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nom</span>
</pre></div>
<p>Certaines teneurs en alcool ne sont pas mentionnées, nous autorisons donc la valeur <strong>null</strong>.</p>
<p>On active cette application dans le fichier <strong>settings.py</strong> de notre projet Django :</p>
<div class="highlight"><pre><span class="c"># ./alcohol/alcohol/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="o">...</span>
    <span class="s">&#39;beer&#39;</span>
<span class="p">)</span>
</pre></div>
<p>On synchronise ensuite la base de données :</p>
<div class="highlight"><pre><span class="nv">$ </span>./manage.py makemigrations
<span class="nv">$ </span>./manage.py migrate
</pre></div>
</div>
<div class="section" id="recuperation-des-bieres-avec-scrapy">
<h2>Récupération des bières avec Scrapy</h2>
<p>Nous allons utiliser <strong>Scrapy</strong> pour extraire les données et les insérer en base.</p>
<p>Toujours dans le dossier <strong>alcohol</strong>, nous créons un dossier <strong>scrapy</strong> qui contiendra nos crawlers (nous n'en aurons qu'un dans notre cas), puis nous initialisons un nouveau projet Scrapy :</p>
<div class="highlight"><pre><span class="nv">$ </span>mkdir scrapy
<span class="nv">$ </span><span class="nb">cd </span>scrapy
<span class="nv">$ </span>scrapy startproject wikibeer
<span class="nv">$ </span><span class="nb">cd </span>wikibeer
</pre></div>
<p>Nous devrions normalement créer une sous-classe de <strong>scrapy.Item</strong>, contenant la liste des données souhaitées (nom, type, degre, brasserie). Néanmoins nous voulons que les données récupérées par Scrapy soient directement accessible via Django. Pour cela nous allons utiliser le package <strong>scrapy-djangoitem</strong> qui se chargera lui-même d'insérer les éléments en base.</p>
<p>Voici donc à quoi ressemble notre classe item :</p>
<div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># ./alcohol/scrapy/wikibeer/wikibeer/items.py</span>

<span class="kn">from</span> <span class="nn">scrapy_djangoitem</span> <span class="kn">import</span> <span class="n">DjangoItem</span>
<span class="kn">from</span> <span class="nn">beer.models</span> <span class="kn">import</span> <span class="n">Beer</span>

<span class="k">class</span> <span class="nc">WikibeerItem</span><span class="p">(</span><span class="n">DjangoItem</span><span class="p">):</span>
    <span class="n">django_model</span> <span class="o">=</span> <span class="n">Beer</span>
</pre></div>
<p>L'accès au modèle <strong>Beer</strong> de notre projet Django est rendu possible en ajoutant les lignes suitantes au fichier <strong>settings.py</strong> de votre projet Scrapy :</p>
<div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># ./alcohol/scrapy/wikibeer/wikibeer/settings.py</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;/opt/projects/alcohol&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;DJANGO_SETTINGS_MODULE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;alcohol.settings&#39;</span>

<span class="o">...</span>
</pre></div>
<p>Pensez à modifier le chemin selon votre configuration.</p>
<p>Il ne reste plus qu'à créer notre spider qui se chargera de retourner les données contenues dans la page :</p>
<div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># ./alcohol/scrapy/wikibeer/wikibeer/spiders/wikibeer_spider.py</span>

<span class="kn">import</span> <span class="nn">scrapy</span>
<span class="kn">from</span> <span class="nn">wikibeer.items</span> <span class="kn">import</span> <span class="n">WikibeerItem</span>


<span class="k">class</span> <span class="nc">WikibeerSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;wikibeer&quot;</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;fr.wikipedia.org&quot;</span><span class="p">]</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&quot;https://fr.wikipedia.org/wiki/Liste_des_bi%C3%A8res_belges&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sel</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&#39;//table[contains(@class, &quot;wikitable&quot;)]//tr&#39;</span><span class="p">):</span>

            <span class="c"># On vérifie qu&#39;il ne s&#39;agit pas du header du tableau</span>
            <span class="n">nom</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&#39;td[1]//text()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nom</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">item</span> <span class="o">=</span> <span class="n">WikibeerItem</span><span class="p">()</span>
            <span class="n">item</span><span class="p">[</span><span class="s">&#39;nom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nom</span><span class="p">)</span>
            <span class="n">item</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&#39;td[2]//text()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
            <span class="n">item</span><span class="p">[</span><span class="s">&#39;degre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&#39;td[3]//text()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
            <span class="n">item</span><span class="p">[</span><span class="s">&#39;brasserie&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&#39;td[4]//text()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>

            <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>Je ne m'attarde pas sur ce code, n'hésitez pas à jeter un oeil à la <a class="reference external" href="http://doc.scrapy.org/en/1.0/">documentation</a> de Scrapy si vous voulez plus d'informations. Scrapy est un crawler web extrèmement puissant, et le spider précédent n'exploite qu'une infime partie de ses possibilités.</p>
<p>Notez tout de même l'utilisation de la méthode <cite>save()</cite> sur l'item (plutôt que de le renvoyer via un <cite>yield</cite>) qui permet d'enregistrer l'objet en base.</p>
<p>Le spider peut enfin être lancé grâce à la commande suivante :</p>
<div class="highlight"><pre><span class="nv">$ </span>scrapy crawl wikibeer
2015-08-27 18:23:50 <span class="o">[</span>scrapy<span class="o">]</span> INFO: Scrapy 1.0.1 started <span class="o">(</span>bot: wikibeer<span class="o">)</span>
2015-08-27 18:23:50 <span class="o">[</span>scrapy<span class="o">]</span> INFO: Optional features available: ssl, http11
2015-08-27 18:23:50 <span class="o">[</span>scrapy<span class="o">]</span> INFO: Overridden settings: <span class="o">{</span><span class="s1">&#39;NEWSPIDER_MODULE&#39;</span>: <span class="s1">&#39;wikibeer.spiders&#39;</span>, <span class="s1">&#39;SPIDER_MODULES&#39;</span>: <span class="o">[</span><span class="s1">&#39;wikibeer.spiders&#39;</span><span class="o">]</span>, <span class="s1">&#39;BOT_NAME&#39;</span>: <span class="s1">&#39;wikibeer&#39;</span><span class="o">}</span>
2015-08-27 18:23:50 <span class="o">[</span>scrapy<span class="o">]</span> INFO: Enabled extensions: CloseSpider, TelnetConsole, LogStats, CoreStats, SpiderState
2015-08-27 18:23:50 <span class="o">[</span>scrapy<span class="o">]</span> INFO: Enabled downloader middlewares: HttpAuthMiddleware, DownloadTimeoutMiddleware, UserAgentMiddleware, RetryMiddleware, DefaultHeadersMiddleware, MetaRefreshMiddleware, HttpCompressionMiddleware, RedirectMiddleware, CookiesMiddleware, ChunkedTransferMiddleware, DownloaderStats
2015-08-27 18:23:50 <span class="o">[</span>scrapy<span class="o">]</span> INFO: Enabled spider middlewares: HttpErrorMiddleware, OffsiteMiddleware, RefererMiddleware, UrlLengthMiddleware, DepthMiddleware
2015-08-27 18:23:50 <span class="o">[</span>scrapy<span class="o">]</span> INFO: Enabled item pipelines:
2015-08-27 18:23:50 <span class="o">[</span>scrapy<span class="o">]</span> INFO: Spider opened
2015-08-27 18:23:50 <span class="o">[</span>scrapy<span class="o">]</span> INFO: Crawled <span class="m">0</span> pages <span class="o">(</span>at <span class="m">0</span> pages/min<span class="o">)</span>, scraped <span class="m">0</span> items <span class="o">(</span>at <span class="m">0</span> items/min<span class="o">)</span>
2015-08-27 18:23:51 <span class="o">[</span>scrapy<span class="o">]</span> DEBUG: Telnet console listening on 127.0.0.1:6023
2015-08-27 18:23:51 <span class="o">[</span>scrapy<span class="o">]</span> DEBUG: Crawled <span class="o">(</span>200<span class="o">)</span> &lt;GET https://fr.wikipedia.org/wiki/Liste_des_bi%C3%A8res_belges&gt; <span class="o">(</span>referer: None<span class="o">)</span>
2015-08-27 18:23:52 <span class="o">[</span>django.db.backends<span class="o">]</span> DEBUG: <span class="o">(</span>0.000<span class="o">)</span> <span class="nv">QUERY</span> <span class="o">=</span> u<span class="s1">&#39;BEGIN&#39;</span> - <span class="nv">PARAMS</span> <span class="o">=</span> <span class="o">()</span><span class="p">;</span> <span class="nv">args</span><span class="o">=</span>None
2015-08-27 18:23:52 <span class="o">[</span>django.db.backends<span class="o">]</span> DEBUG: <span class="o">(</span>0.001<span class="o">)</span> <span class="nv">QUERY</span> <span class="o">=</span> u<span class="s1">&#39;INSERT INTO &quot;beer_beer&quot; (&quot;nom&quot;, &quot;type&quot;, &quot;degre&quot;, &quot;brasserie&quot;) VALUES (%s, %s, %s, %s)&#39;</span> - <span class="nv">PARAMS</span> <span class="o">=</span> <span class="o">(</span>u<span class="s1">&#39;3 Scht\xe9ng&#39;</span>, u<span class="s1">&#39;Fermentation haute&#39;</span>, u<span class="s1">&#39;6\xa0%&#39;</span>, u<span class="s2">&quot;Brasserie Grain d&#39;Orge&quot;</span><span class="o">)</span><span class="p">;</span> <span class="nv">args</span><span class="o">=[</span>u<span class="s1">&#39;3 Scht\xe9ng&#39;</span>, u<span class="s1">&#39;Fermentation haute&#39;</span>, u<span class="s1">&#39;6\xa0%&#39;</span>, u<span class="s2">&quot;Brasserie Grain d&#39;Orge&quot;</span><span class="o">]</span>
2015-08-27 18:23:52 <span class="o">[</span>scrapy<span class="o">]</span> INFO: Received SIGINT, shutting down gracefully. Send again to force
2015-08-27 18:23:52 <span class="o">[</span>django.db.backends<span class="o">]</span> DEBUG: <span class="o">(</span>0.000<span class="o">)</span> <span class="nv">QUERY</span> <span class="o">=</span> u<span class="s1">&#39;BEGIN&#39;</span> - <span class="nv">PARAMS</span> <span class="o">=</span> <span class="o">()</span><span class="p">;</span> <span class="nv">args</span><span class="o">=</span>None
2015-08-27 18:23:52 <span class="o">[</span>django.db.backends<span class="o">]</span> DEBUG: <span class="o">(</span>0.000<span class="o">)</span> <span class="nv">QUERY</span> <span class="o">=</span> u<span class="s1">&#39;INSERT INTO &quot;beer_beer&quot; (&quot;nom&quot;, &quot;type&quot;, &quot;degre&quot;, &quot;brasserie&quot;) VALUES (%s, %s, %s, %s)&#39;</span> - <span class="nv">PARAMS</span> <span class="o">=</span> <span class="o">(</span>u<span class="s1">&#39;IV Saison&#39;</span>, u<span class="s1">&#39;Saison&#39;</span>, u<span class="s1">&#39;6,5\xa0%&#39;</span>, u<span class="s1">&#39;Brasserie de Jandrain-Jandrenouille&#39;</span><span class="o">)</span><span class="p">;</span> <span class="nv">args</span><span class="o">=[</span>u<span class="s1">&#39;IV Saison&#39;</span>, u<span class="s1">&#39;Saison&#39;</span>, u<span class="s1">&#39;6,5\xa0%&#39;</span>, u<span class="s1">&#39;Brasserie de Jandrain-Jandrenouille&#39;</span><span class="o">]</span>
2015-08-27 18:23:52 <span class="o">[</span>django.db.backends<span class="o">]</span> DEBUG: <span class="o">(</span>0.000<span class="o">)</span> <span class="nv">QUERY</span> <span class="o">=</span> u<span class="s1">&#39;BEGIN&#39;</span> - <span class="nv">PARAMS</span> <span class="o">=</span> <span class="o">()</span><span class="p">;</span> <span class="nv">args</span><span class="o">=</span>None
2015-08-27 18:23:52 <span class="o">[</span>django.db.backends<span class="o">]</span> DEBUG: <span class="o">(</span>0.000<span class="o">)</span> <span class="nv">QUERY</span> <span class="o">=</span> u<span class="s1">&#39;INSERT INTO &quot;beer_beer&quot; (&quot;nom&quot;, &quot;type&quot;, &quot;degre&quot;, &quot;brasserie&quot;) VALUES (%s, %s, %s, %s)&#39;</span> - <span class="nv">PARAMS</span> <span class="o">=</span> <span class="o">(</span>u<span class="s1">&#39;V Cense&#39;</span>, u<span class="s1">&#39;Fermentation haute, Sp\xe9ciale&#39;</span>, u<span class="s1">&#39;7,5\xa0%&#39;</span>, u<span class="s1">&#39;Brasserie de Jandrain-Jandrenouille&#39;</span><span class="o">)</span><span class="p">;</span> <span class="nv">args</span><span class="o">=[</span>u<span class="s1">&#39;V Cense&#39;</span>, u<span class="s1">&#39;Fermentation haute, Sp\xe9ciale&#39;</span>, u<span class="s1">&#39;7,5\xa0%&#39;</span>, u<span class="s1">&#39;Brasserie de Jandrain-Jandrenouille&#39;</span><span class="o">]</span>
2015-08-27 18:23:52 <span class="o">[</span>django.db.backends<span class="o">]</span> DEBUG: <span class="o">(</span>0.000<span class="o">)</span> <span class="nv">QUERY</span> <span class="o">=</span> u<span class="s1">&#39;BEGIN&#39;</span> - <span class="nv">PARAMS</span> <span class="o">=</span> <span class="o">()</span><span class="p">;</span> <span class="nv">args</span><span class="o">=</span>None
2015-08-27 18:23:52 <span class="o">[</span>django.db.backends<span class="o">]</span> DEBUG: <span class="o">(</span>0.000<span class="o">)</span> <span class="nv">QUERY</span> <span class="o">=</span> u<span class="s1">&#39;INSERT INTO &quot;beer_beer&quot; (&quot;nom&quot;, &quot;type&quot;, &quot;degre&quot;, &quot;brasserie&quot;) VALUES (%s, %s, %s, %s)&#39;</span> - <span class="nv">PARAMS</span> <span class="o">=</span> <span class="o">(</span>u<span class="s1">&#39;VI Wheat&#39;</span>, u<span class="s1">&#39;Fermentation haute, Blanche&#39;</span>, u<span class="s1">&#39;6\xa0%&#39;</span>, u<span class="s1">&#39;Brasserie de Jandrain-Jandrenouille&#39;</span><span class="o">)</span><span class="p">;</span> <span class="nv">args</span><span class="o">=[</span>u<span class="s1">&#39;VI Wheat&#39;</span>, u<span class="s1">&#39;Fermentation haute, Blanche&#39;</span>, u<span class="s1">&#39;6\xa0%&#39;</span>, u<span class="s1">&#39;Brasserie de Jandrain-Jandrenouille&#39;</span><span class="o">]</span>
2015-08-27 18:23:52 <span class="o">[</span>django.db.backends<span class="o">]</span> DEBUG: <span class="o">(</span>0.000<span class="o">)</span> <span class="nv">QUERY</span> <span class="o">=</span> u<span class="s1">&#39;BEGIN&#39;</span> - <span class="nv">PARAMS</span> <span class="o">=</span> <span class="o">()</span><span class="p">;</span> <span class="nv">args</span><span class="o">=</span>None
2015-08-27 18:23:52 <span class="o">[</span>django.db.backends<span class="o">]</span> DEBUG: <span class="o">(</span>0.000<span class="o">)</span> <span class="nv">QUERY</span> <span class="o">=</span> u<span class="s1">&#39;INSERT INTO &quot;beer_beer&quot; (&quot;nom&quot;, &quot;type&quot;, &quot;degre&quot;, &quot;brasserie&quot;) VALUES (%s, %s, %s, %s)&#39;</span> - <span class="nv">PARAMS</span> <span class="o">=</span> <span class="o">(</span>u<span class="s1">&#39;26.2 M&#39;</span>, u<span class="s1">&#39;Blonde&#39;</span>, u<span class="s1">&#39;4,8\xa0%&#39;</span>, u<span class="s2">&quot;Brasserie L&#39;\xc9chapp\xe9e Belle&quot;</span><span class="o">)</span><span class="p">;</span> <span class="nv">args</span><span class="o">=[</span>u<span class="s1">&#39;26.2 M&#39;</span>, u<span class="s1">&#39;Blonde&#39;</span>, u<span class="s1">&#39;4,8\xa0%&#39;</span>, u<span class="s2">&quot;Brasserie L&#39;\xc9chapp\xe9e Belle&quot;</span><span class="o">]</span>
...
</pre></div>
<p>Les données sont bien enregistrées en base de données, le tout en passant par notre modèle Django :</p>
<img alt="/images/scrapy-django-rest-1.png" class="align-center" src="/images/scrapy-django-rest-1.png" />
</div>
<div class="section" id="mise-en-place-de-django-rest-framework">
<h2>Mise en place de Django Rest Framework</h2>
<p>Nous avons maintenant la liste entière des bières dans notre base de données. Nous pouvons créer un serializer basé sur notre modèle <strong>Beer</strong> :</p>
<div class="highlight"><pre><span class="c"># ./alcohol/beer/serializers.py</span>

<span class="kn">from</span> <span class="nn">beer.models</span> <span class="kn">import</span> <span class="n">Beer</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>

<span class="k">class</span> <span class="nc">BeerSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Beer</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;nom&#39;</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="s">&#39;degre&#39;</span><span class="p">,</span> <span class="s">&#39;brasserie&#39;</span><span class="p">)</span>
</pre></div>
<p>Nous créons ensuite une vue qui sera une sous-classe de <strong>rest_framework.viewsets.ModelViewSet</strong> dans laquelle nous renseignons la requête utilisée (toutes les bières) et le serializer créé précédemment :</p>
<div class="highlight"><pre><span class="c"># ./alcohol/beer/views.py</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>
<span class="kn">from</span> <span class="nn">beer.models</span> <span class="kn">import</span> <span class="n">Beer</span>
<span class="kn">from</span> <span class="nn">beer.serializers</span> <span class="kn">import</span> <span class="n">BeerSerializer</span>

<span class="k">class</span> <span class="nc">BeerViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Beer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BeerSerializer</span>
</pre></div>
<p>Les urls de notre projet doivent être renseignées dans le fichier <strong>alcohol/urls.py</strong> (dans notre cas l'API sera accessible via <a class="reference external" href="http://.../api/beers/">http://.../api/beers/</a>) :</p>
<div class="highlight"><pre><span class="c"># ./alcohol/alcohol/urls.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span>
<span class="kn">from</span> <span class="nn">beer.views</span> <span class="kn">import</span> <span class="n">BeerViewSet</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">routers</span><span class="o">.</span><span class="n">DefaultRouter</span><span class="p">()</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">r&#39;api/beers&#39;</span><span class="p">,</span> <span class="n">BeerViewSet</span><span class="p">)</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">urls</span><span class="p">))</span>
<span class="p">]</span>
</pre></div>
<p>Il ne reste plus qu'à activer l'application <strong>Django Rest Framework</strong> dans le fichier <strong>settings.py</strong> de notre projet Django :</p>
<div class="highlight"><pre><span class="c"># ./alcohol/alcohol/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="o">...</span>
        <span class="s">&#39;rest_framework&#39;</span><span class="p">,</span>
        <span class="s">&#39;beer&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="section" id="test-de-l-api">
<h2>Test de l'API</h2>
<p>Et voilà ! Nous avons rapratrier un jeu de données via Scrapy, nous avons mis en place notre API via Django Rest Framework, nous pouvons désormais la tester.</p>
<p>On lance tout d'abord le serveur :</p>
<div class="highlight"><pre><span class="nv">$ </span>./manage.py runserver
Performing system checks...

System check identified no issues <span class="o">(</span><span class="m">0</span> silenced<span class="o">)</span>.
August 27, <span class="m">2015</span> - 18:28:08
Django version 1.8.4, using settings <span class="s1">&#39;alcohol.settings&#39;</span>
Starting development server at http://127.0.0.1:8000/
Quit the server with CONTROL-C.
</pre></div>
<p>Puis nous utilisons <strong>curl</strong> (par exemple) pour accéder à notre API :</p>
<div class="highlight"><pre><span class="nv">$ </span>curl -H <span class="s1">&#39;Accept: application/json; indent=4&#39;</span> http://127.0.0.1:8000/api/beers/
...
<span class="o">{</span>
    <span class="s2">&quot;nom&quot;</span>: <span class="s2">&quot;Abbaye du Park Blonde&quot;</span>,
    <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;Abbaye, Blonde&quot;</span>,
    <span class="s2">&quot;degre&quot;</span>: <span class="s2">&quot;6 %&quot;</span>,
    <span class="s2">&quot;brasserie&quot;</span>: <span class="s2">&quot;Brasserie Haacht&quot;</span>
<span class="o">}</span>,
<span class="o">{</span>
    <span class="s2">&quot;nom&quot;</span>: <span class="s2">&quot;Abbaye du Park Brune&quot;</span>,
    <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;Abbaye, Brune&quot;</span>,
    <span class="s2">&quot;degre&quot;</span>: <span class="s2">&quot;6 %&quot;</span>,
    <span class="s2">&quot;brasserie&quot;</span>: <span class="s2">&quot;Brasserie Haacht&quot;</span>
<span class="o">}</span>,
<span class="o">{</span>
    <span class="s2">&quot;nom&quot;</span>: <span class="s2">&quot;Abdis Blond&quot;</span>,
    <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;Blonde&quot;</span>,
    <span class="s2">&quot;degre&quot;</span>: <span class="s2">&quot;6,5 %&quot;</span>,
    <span class="s2">&quot;brasserie&quot;</span>: <span class="s2">&quot;Brasserie Riva&quot;</span>
<span class="o">}</span>,
<span class="o">{</span>
    <span class="s2">&quot;nom&quot;</span>: <span class="s2">&quot;Abdis Bruin&quot;</span>,
    <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;Brune&quot;</span>,
    <span class="s2">&quot;degre&quot;</span>: <span class="s2">&quot;6,5 %&quot;</span>,
    <span class="s2">&quot;brasserie&quot;</span>: <span class="s2">&quot;Brasserie Riva&quot;</span>
<span class="o">}</span>
...
</pre></div>
<p>Notez pour finir que <strong>Django Rest Framework</strong> fournit également une interface web pour consulter votre API :</p>
<img alt="/images/scrapy-django-rest-2.png" class="align-center" src="/images/scrapy-django-rest-2.png" />
<img alt="/images/scrapy-django-rest-3.png" class="align-center" src="/images/scrapy-django-rest-3.png" />
</div>
</div>


            <a href="https://twitter.com/share" class="twitter-share-button" data-url="https://ncrocfer.github.io/2015/08/27/creation-dapi-avec-scrapy-et-django" data-text="Création d'API avec Scrapy et Django" data-via="ncrocfer">Tweet</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

            <div class="hr"></div>
            <a href="#" class="go-top">Go Top</a>
            <footer class="footer">
    <p>&copy; ncrocfer &ndash;
        Built with <a href="https://github.com/ncrocfer/radric">Radric</a>
        and a modified version of <a href="https://github.com/PurePelicanTheme/pure">Pure Theme</a>
    </p>
</footer>
        </div>
    </div>
</div>

<script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-65778407-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>